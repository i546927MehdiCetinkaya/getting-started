name: Deploy to Azure Container Instances

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Authenticate with Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Deploy container with all required parameters
      - name: Create/Update Container Instance
        run: |
          # Force-replace existing container
          az container delete \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name getting-started \
            --yes || true

          # Create with required CPU/memory specs
          az container create \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name getting-started \
            --image ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ secrets.REPOSITORY_NAME }}:v1 \
            --registry-username ${{ secrets.REGISTRY_USERNAME }} \
            --registry-password ${{ secrets.REGISTRY_PASSWORD }} \
            --azure-file-volume-share-name ${{ secrets.AZURE_STORAGE_SHARE_NAME }} \
            --azure-file-volume-account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
            --azure-file-volume-mount-path /etc/todos \
            --ports 3000 \
            --os-type Linux \
            --restart-policy Always \
            --cpu 1 \          # Required: Number of CPU cores
            --memory 1.5       # Required: Memory in GB
