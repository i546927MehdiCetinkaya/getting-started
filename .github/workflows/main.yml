name: Deploy to Azure Container Instances

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Authenticate with Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Delete existing container (ignore if not exists)
      - name: Delete existing container
        run: |
          az container delete \
            --resource-group RGR-ACR \
            --name getting-started \
            --yes || true

      # Create new container with mounted file share and ACR access
      - name: Create Container with file share
        run: |
          az container create \
            --resource-group RGR-ACR \
            --name getting-started \
            --image registryvanmehdi.azurecr.io/gettingstarted:v1 \
            --registry-login-server registryvanmehdi.azurecr.io \
            --registry-username ${{ secrets.REGISTRY_USERNAME }} \
            --registry-password ${{ secrets.REGISTRY_PASSWORD }} \
            --azure-file-volume-share-name sharevanmehdi \
            --azure-file-volume-account-name storagevanmehdi \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
            --azure-file-volume-mount-path /etc/todos \
            --ports 3000 \
            --os-type Linux \
            --restart-policy Always \
            --cpu 1 \
            --memory 1.5
